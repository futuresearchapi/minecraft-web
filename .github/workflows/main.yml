name: Sync external minecraft.html release to Netlify

on:
  schedule:
    - cron: "0 0 */2 * *"  # every 2 days
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. Check for new release and decide whether to proceed
      - name: Check for new release
        id: check_release
        run: |
          set -e
          # Fetch latest release info from GitHub API
          latest_release_json=$(curl -s https://api.github.com/repos/zardoy/minecraft-web-client/releases/latest)
          
          # Extract latest release tag
          latest_tag=$(echo "$latest_release_json" | grep -oP '(?<="tag_name": ")[^"]+')
          echo "Latest release tag: $latest_tag"
          
          # Path to version file
          VERSION_FILE=".last_release_version"
          
          # Check if version file exists
          if [ -f "$VERSION_FILE" ]; then
            stored_version=$(cat "$VERSION_FILE")
            echo "Stored version: $stored_version"
          else
            stored_version=""
            echo "Version file does not exist. Creating it now."
          fi
          
          # Compare versions
          if [ "$latest_tag" = "$stored_version" ]; then
            echo "No new release detected. Exiting."
            echo "release_found=false" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "New release detected. Proceeding."
            echo "release_found=true" >> $GITHUB_OUTPUT
            # Save new version for future runs
            echo "$latest_tag" > "$VERSION_FILE"
            echo "Saved new version to $VERSION_FILE"
          fi

      # Exit early if no new release
      - name: Stop if no new release
        if: steps.check_release.outputs.release_found == 'false'
        run: |
          echo "No new release. Exiting workflow."
          exit 1

      # 2. Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v3

      # 3. Clear old site files (keep .git, workflow, .gitignore, and .last_release_version)
      - name: Clear old files
        run: |
          find . -mindepth 1 -maxdepth 1 ! -name ".git" ! -name ".github" ! -name ".gitignore" ! -name ".last_release_version" -exec rm -rf {} + || true

      # 4. Download minecraft.html only if there's a new release
      - name: Download minecraft.html
        if: steps.check_release.outputs.release_found == 'true'
        run: |
          curl -L -o index.html https://github.com/zardoy/minecraft-web-client/releases/latest/download/minecraft.html
          echo "Downloaded new minecraft.html."

      # 5. Verify the file exists only if it was downloaded
      - name: Verify index.html
        if: steps.check_release.outputs.release_found == 'true'
        run: |
          if [ -f index.html ]; then
            echo "index.html downloaded successfully."
          else
            echo "index.html not found — skipping commit"
            exit 0
          fi

      # 6. Commit and push only if a new release was found and file exists
      - name: Commit and push changes
        if: steps.check_release.outputs.release_found == 'true'
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes — skipping commit."
            exit 0
          fi
          git commit -m "Update index.html from latest minecraft.html release"
          git push
